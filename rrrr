import sys
import json
from PyQt5 import QtCore, QtWidgets
from PyQt5.QtWidgets import QDialog, QVBoxLayout, QLabel, QLineEdit, QTextEdit, QPushButton, QDateEdit, QMessageBox, QListWidgetItem
from PyQt5.QtCore import QDate

# –î–∏–∞–ª–æ–≥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫
class NoteDialog(QDialog):
    def init(self, title="", content="", date=None, parent=None):
        super().init(parent)
        self.setWindowTitle("–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É" if not title else "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É")
        self.layout = QVBoxLayout(self)

        # –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏
        self.label_title = QLabel("–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏:")
        self.layout.addWidget(self.label_title)
        self.title_input = QLineEdit(self)
        self.title_input.setText(title)
        self.layout.addWidget(self.title_input)

        # –ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏
        self.label_content = QLabel("–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏:")
        self.layout.addWidget(self.label_content)
        self.content_input = QTextEdit(self)
        self.content_input.setFixedHeight(150)
        self.content_input.setText(content)
        self.layout.addWidget(self.content_input)

        # –ü–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã –∑–∞–º–µ—Ç–∫–∏
        self.label_date = QLabel("–î–∞—Ç–∞ –∑–∞–º–µ—Ç–∫–∏:")
        self.layout.addWidget(self.label_date)
        self.date_input = QDateEdit(self)
        self.date_input.setCalendarPopup(True)
        self.date_input.setDate(date if date else QDate.currentDate())
        self.layout.addWidget(self.date_input)

        # –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        self.save_button = QPushButton("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", self)
        self.save_button.clicked.connect(self.validate_input)  # –ò–∑–º–µ–Ω–µ–Ω–æ: –¥–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏
        self.layout.addWidget(self.save_button)

    # –ú–µ—Ç–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–º–µ—Ç–∫–∏
    def validate_input(self):
        if not self.title_input.text().strip() and not self.content_input.toPlainText().strip():
            QMessageBox.warning(self, "–û—à–∏–±–∫–∞", "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏.")
        else:
            self.accept()

    def get_data(self):
        return self.title_input.text(), self.content_input.toPlainText(), self.date_input.date().toString("yyyy-MM-dd")

# –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
class Ui_Ezenedelnik(object):
    def setupUi(self, Ezenedelnik):
        Ezenedelnik.setObjectName("Ezenedelnik")
        Ezenedelnik.resize(800, 600)
        self.centralwidget = QtWidgets.QWidget(Ezenedelnik)
        self.centralwidget.setObjectName("centralwidget")

        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–º–µ—Ç–∫–∏
        self.Udalitzametky = QtWidgets.QPushButton(self.centralwidget)
        self.Udalitzametky.setGeometry(QtCore.QRect(385, 180, 360, 50))
        self.Udalitzametky.setStyleSheet(
            "QPushButton {border: 2px solid #FF0000; border-radius: 12px; background-color: #f0f0f0; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #FFCCCC;}"
        )
        self.Udalitzametky.setText("–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É")
        self.Udalitzametky.setObjectName("Udalitzametky")

        # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫
        self.show_all_notes_button = QtWidgets.QPushButton(self.centralwidget)
        self.show_all_notes_button.setGeometry(QtCore.QRect(170, 18, 150, 40))
        self.show_all_notes_button.setText("–í—Å–µ –∑–∞–º–µ—Ç–∫–∏")
        self.show_all_notes_button.setStyleSheet("QPushButton {border: 2px solid #B0B0B0; border-radius: 12px; background-color: #E8E8E8; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #F0F0F0;}")

> –¢–∏–º–æ—Ö–∞üëª:
# –°–ø–∏—Å–æ–∫ –∑–∞–º–µ—Ç–æ–∫ —Å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º
        self.ListZametok = QtWidgets.QListWidget(self.centralwidget)
        self.ListZametok.setGeometry(QtCore.QRect(40, 65, 281, 421))
        self.ListZametok.setObjectName("ListZametok")
        self.ListZametok.setStyleSheet("""
            QListWidget::item {
                border: 1px solid #B0B0B0;
                padding: 8px;
                margin: 5px 0;
                border-radius: 5px;
                background-color: #FFFFFF;
            }
            QListWidget::item:selected {
                background-color: #E0F7FA;
                color: #000000;
            }
        """)

        # –ú–µ—Ç–∫–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–º–µ—Ç–æ–∫
        self.Moi_zametki = QtWidgets.QLabel(self.centralwidget)
        self.Moi_zametki.setGeometry(QtCore.QRect(40, 45, 121, 16))
        self.Moi_zametki.setObjectName("Moi_zametki")

        # –û—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        self.add_urgent_note_button = QtWidgets.QPushButton(self.centralwidget)
        self.add_urgent_note_button.setGeometry(QtCore.QRect(340, 30, 210, 60))
        self.add_urgent_note_button.setText("–°—Ä–æ—á–Ω–æ–µ")
        self.add_urgent_note_button.setStyleSheet("QPushButton {border: 2px solid #4CAF50; border-radius: 12px; background-color: #f0f0f0; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #d0e4e8;}")

        self.add_important_note_button = QtWidgets.QPushButton(self.centralwidget)
        self.add_important_note_button.setGeometry(QtCore.QRect(560, 30, 210, 60))
        self.add_important_note_button.setText("–í–∞–∂–Ω–æ–µ")
        self.add_important_note_button.setStyleSheet("QPushButton {border: 2px solid #4CAF50; border-radius: 12px; background-color: #f0f0f0; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #d0e4e8;}")

        self.add_non_urgent_note_button = QtWidgets.QPushButton(self.centralwidget)
        self.add_non_urgent_note_button.setGeometry(QtCore.QRect(340, 100, 210, 60))
        self.add_non_urgent_note_button.setText("–ù–µ —Å—Ä–æ—á–Ω–æ–µ")
        self.add_non_urgent_note_button.setStyleSheet("QPushButton {border: 2px solid #4CAF50; border-radius: 12px; background-color: #f0f0f0; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #d0e4e8;}")

        self.add_non_important_note_button = QtWidgets.QPushButton(self.centralwidget)
        self.add_non_important_note_button.setGeometry(QtCore.QRect(560, 100, 210, 60))
        self.add_non_important_note_button.setText("–ù–µ –≤–∞–∂–Ω–æ–µ")
        self.add_non_important_note_button.setStyleSheet("QPushButton {border: 2px solid #4CAF50; border-radius: 12px; background-color: #f0f0f0; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #d0e4e8;}")

        # –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∑–∞–º–µ—Ç–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
        self.filter_urgent_button = QtWidgets.QPushButton(self.centralwidget)
        self.filter_urgent_button.setGeometry(QtCore.QRect(20, 500, 160, 40))
        self.filter_urgent_button.setText("–ü–æ–∫–∞–∑–∞—Ç—å –°—Ä–æ—á–Ω–æ–µ")
        self.filter_urgent_button.setStyleSheet("QPushButton {border: 2px solid #B0B0B0; border-radius: 12px; background-color: #E8E8E8; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #F0F0F0;}")

        self.filter_important_button = QtWidgets.QPushButton(self.centralwidget)
        self.filter_important_button.setGeometry(QtCore.QRect(185, 500, 160, 40))
        self.filter_important_button.setText("–ü–æ–∫–∞–∑–∞—Ç—å –í–∞–∂–Ω–æ–µ")
        self.filter_important_button.setStyleSheet("QPushButton {border: 2px solid #B0B0B0; border-radius: 12px; background-color: #E8E8E8; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #F0F0F0;}")

> –¢–∏–º–æ—Ö–∞üëª:
self.filter_non_urgent_button = QtWidgets.QPushButton(self.centralwidget)
        self.filter_non_urgent_button.setGeometry(QtCore.QRect(20, 550, 160, 40))
        self.filter_non_urgent_button.setText("–ü–æ–∫–∞–∑–∞—Ç—å –ù–µ —Å—Ä–æ—á–Ω–æ–µ")
        self.filter_non_urgent_button.setStyleSheet("QPushButton {border: 2px solid #B0B0B0; border-radius: 12px; background-color: #E8E8E8; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #F0F0F0;}")

        self.filter_non_important_button = QtWidgets.QPushButton(self.centralwidget)
        self.filter_non_important_button.setGeometry(QtCore.QRect(185, 550, 160, 40))
        self.filter_non_important_button.setText("–ü–æ–∫–∞–∑–∞—Ç—å –ù–µ –≤–∞–∂–Ω–æ–µ")
        self.filter_non_important_button.setStyleSheet("QPushButton {border: 2px solid #B0B0B0; border-radius: 12px; background-color: #E8E8E8; padding: 10px; font-size: 14px;} QPushButton:hover {background-color: #F0F0F0;}")

        # –ö–∞–ª–µ–Ω–¥–∞—Ä—å –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã
        self.calendarWidget = QtWidgets.QCalendarWidget(self.centralwidget)
        self.calendarWidget.setGeometry(QtCore.QRect(350, 250, 430, 250))
        self.calendarWidget.setObjectName("calendarWidget")

        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
        self.add_urgent_note_button.clicked.connect(lambda: self.add_note_with_category("–°—Ä–æ—á–Ω–æ–µ"))
        self.add_important_note_button.clicked.connect(lambda: self.add_note_with_category("–í–∞–∂–Ω–æ–µ"))
        self.add_non_urgent_note_button.clicked.connect(lambda: self.add_note_with_category("–ù–µ —Å—Ä–æ—á–Ω–æ–µ"))
        self.add_non_important_note_button.clicked.connect(lambda: self.add_note_with_category("–ù–µ –≤–∞–∂–Ω–æ–µ"))

        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º
        self.filter_urgent_button.clicked.connect(lambda: self.show_notes_by_category("–°—Ä–æ—á–Ω–æ–µ"))
        self.filter_important_button.clicked.connect(lambda: self.show_notes_by_category("–í–∞–∂–Ω–æ–µ"))
        self.filter_non_urgent_button.clicked.connect(lambda: self.show_notes_by_category("–ù–µ —Å—Ä–æ—á–Ω–æ–µ"))
        self.filter_non_important_button.clicked.connect(lambda: self.show_notes_by_category("–ù–µ –≤–∞–∂–Ω–æ–µ"))

        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —É–¥–∞–ª–µ–Ω–∏—é –∑–∞–º–µ—Ç–æ–∫, –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫ –∏ –≤—ã–±–æ—Ä—É –¥–∞—Ç—ã
        self.Udalitzametky.clicked.connect(self.remove_note)
        self.show_all_notes_button.clicked.connect(self.show_all_notes)
        self.calendarWidget.clicked.connect(self.show_notes_for_date)

        # –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–º–µ—Ç–æ–∫
        self.ListZametok.itemDoubleClicked.connect(self.edit_note)

        Ezenedelnik.setCentralWidget(self.centralwidget)
        self.retranslateUi(Ezenedelnik)
        self.load_notes()
        self.show_all_notes()

    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç—ã –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –≤–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–∫–Ω–∞ –∏ —Ç–µ–∫—Å—Ç –¥–ª—è –º–µ—Ç–∫–∏ "–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏".
    def retranslateUi(self, Ezenedelnik):
        _translate = QtCore.QCoreApplication.translate
        Ezenedelnik.setWindowTitle(_translate("Ezenedelnik", "–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–∏–∫"))
        self.Moi_zametki.setText(_translate("Ezenedelnik", "–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏"))

    # –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–º–µ—Ç–æ–∫ –∏–∑ —Ñ–∞–π–ª–∞
    def load_notes(self):
        try:
            with open("notes.json", "r", encoding="utf-8") as f:
                self.notes = json.load(f)
        except FileNotFoundError:
            self.notes = []

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∑–∞–º–µ—Ç–æ–∫ –≤ —Ñ–∞–π–ª
    def save_notes(self):
        with open("notes.json", "w", encoding="utf-8") as f:
            json.dump(self.notes, f, ensure_ascii=False, indent=4)

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏ –≤ –≤–∏–¥–∂–µ—Ç —Å–ø–∏—Å–∫–∞
    def add_note_to_list(self, note):
        if isinstance(note, dict):
            display_content = note['content'][:40] + '...' if len(note['content']) > 40 else note['content']
            item_text = f"{note['date']} - {note['title']}: {display_content}"
            list_item = QListWidgetItem(item_text)
            list_item.setData(QtCore.Qt.UserRole, note)
            self.ListZametok.addItem(list_item)
        else:
            print("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–º–µ—Ç–∫–∏:", note)

> –¢–∏–º–æ—Ö–∞üëª:
# –ú–µ—Ç–æ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–º–µ—Ç–∫–∏ —Å –∫–∞—Ç–µ–≥–æ—Ä–∏–µ–π
    def edit_note(self, item):
        note = item.data(QtCore.Qt.UserRole)
        dialog = NoteDialog(note['title'], note['content'], QDate.fromString(note['date'], "yyyy-MM-dd"))
        if dialog.exec_() == QDialog.Accepted:
            title, content, date = dialog.get_data()
            note['title'] = title
            note['content'] = content
            note['date'] = date
            self.save_notes()
            self.show_all_notes()

    # –ú–µ—Ç–æ–¥ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∑–∞–º–µ—Ç–∫–∏
    def remove_note(self):
        selected_items = self.ListZametok.selectedItems()
        if not selected_items:
            return

        # –°–æ–∑–¥–∞–µ–º –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –≤—Ä—É—á–Ω—É—é
        reply = QMessageBox(self.centralwidget)
        reply.setWindowTitle("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ")
        reply.setText("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏?")

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ —Å –Ω—É–∂–Ω—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏
        yes_button = reply.addButton("–î–∞", QMessageBox.YesRole)
        no_button = reply.addButton("–ù–µ—Ç", QMessageBox.NoRole)

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ
        reply.exec_()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞–∫–∞—è –∫–Ω–æ–ø–∫–∞ –±—ã–ª–∞ –Ω–∞–∂–∞—Ç–∞
        if reply.clickedButton() == yes_button:
            for item in selected_items:
                self.ListZametok.takeItem(self.ListZametok.row(item))
                self.notes.remove(item.data(QtCore.Qt.UserRole))
            self.save_notes()

    # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫ –≤ —Å–ø–∏—Å–∫–µ
    def show_all_notes(self):
        self.ListZametok.clear()
        for note in self.notes:
            self.add_note_to_list(note)

    # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞–º–µ—Ç–æ–∫ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    def show_notes_by_category(self, category):
        self.ListZametok.clear()
        for note in self.notes:
            if note.get("category") == category:
                self.add_note_to_list(note)

    # –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã –∏–∑ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    def show_notes_for_date(self, date):
        self.ListZametok.clear()
        for note in self.notes:
            if note.get("date") == date.toString("yyyy-MM-dd"):
                self.add_note_to_list(note)

    # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∑–∞–º–µ—Ç–∫—É –≤ —Å–ø–∏—Å–∫–µ –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–º–µ—Ç–æ–∫.
    def add_note_with_category(self, category):
        dialog = NoteDialog()
        if dialog.exec_() == QDialog.Accepted:
            title, content, date = dialog.get_data()
            title = f"{category} - {title}"  # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∫ –Ω–∞–∑–≤–∞–Ω–∏—é
            new_note = {"title": title, "content": content, "date": date, "category": category}
            self.notes.append(new_note)
            self.save_notes()
            self.show_all_notes()

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if name == "main":
    app = QtWidgets.QApplication(sys.argv)
    Ezenedelnik = QtWidgets.QMainWindow()
    ui = Ui_Ezenedelnik()
    ui.setupUi(Ezenedelnik)
    Ezenedelnik.show()
    sys.exit(app.exec_())
